<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criminal Investigation Division</title>
    <style>
        :root { --bg: #0a0a0a; --text: #e0e0e0; --accent: #00ff41; --dim: #444; --err: #ff3333; --panel: #111; }
        body { background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; margin: 0; padding: 0; }
        a { color: var(--accent); text-decoration: none; cursor: pointer; }
        a:hover { text-decoration: underline; }
        header { background: var(--panel); padding: 1rem; border-bottom: 1px solid var(--dim); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .brand { font-weight: bold; font-size: 1.2rem; }
        nav { display: flex; gap: 15px; flex-wrap: wrap; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* PAGE SECTIONS - FIXED NAVIGATION */
        .page-section { display: none; animation: fade 0.3s; }
        .page-section.active { display: block; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--panel); border: 1px solid var(--dim); padding: 15px; margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
        
        input, textarea, button, select { background: #222; border: 1px solid var(--dim); color: var(--text); padding: 8px; font-family: inherit; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        button { background: var(--dim); cursor: pointer; font-weight: bold; }
        button:hover { background: var(--accent); color: #000; }
        
        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--panel); border: 1px solid var(--accent); padding: 20px; width: 600px; max-width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .close-btn { cursor: pointer; color: var(--err); font-weight: bold; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { border: 1px solid var(--dim); padding: 8px; text-align: left; }
        th { background: #222; }
        .status-ok { color: var(--accent); }
        .status-err { color: var(--err); }
        .hidden { display: none !important; }
        .profile-card { text-align: center; }
        .profile-img { width: 100px; height: 100px; border-radius: 50%; border: 2px solid var(--accent); margin-bottom: 10px; }
    </style>
</head>
<body>

<header>
    <div class="brand">Criminal Investigation Division</div>
    <nav>
        <a onclick="navigateTo('home')">Home</a>
        <a onclick="navigateTo('about')">About</a>
        <a onclick="navigateTo('contact')">Contact</a>
        <a onclick="navigateTo('admin')" id="nav-admin" class="hidden">Admin</a>
        <a onclick="openSettings()" id="nav-settings" class="hidden">Settings</a>
        <a onclick="logout()" id="nav-logout" class="hidden">Logout</a>
        <a onclick="navigateTo('login')" id="nav-login">Login</a>
    </nav>
</header>

<div class="container">

    <!-- HOME -->
    <div id="home" class="page-section active">
        <h1>Overview</h1>
        <div class="card">
            <h3>Latest News</h3>
            <div id="news-feed"><p>No news posted.</p></div>
        </div>
    </div>

    <!-- ABOUT -->
    <div id="about" class="page-section">
        <h1>About</h1>
        <div class="grid">
            <div class="card">
                <h3 id="about-box1-title">Office of Special Investigations</h3>
                <p id="about-box1-desc">Handles complex internal investigations and sensitive matters.</p>
                <small id="about-box1-roles">Office Chief: USERNAME | Office Sergeant Major: USERNAME</small>
            </div>
            <div class="card">
                <h3 id="about-box2-title">Office of Criminal Investigations</h3>
                <p id="about-box2-desc">Responsible for felony-level investigations and major crimes.</p>
                <small id="about-box2-roles">Office Chief: USERNAME | Office Sergeant Major: USERNAME</small>
            </div>
        </div>
    </div>

    <!-- CONTACT -->
    <div id="contact" class="page-section">
        <h1>Contact</h1>
        <div id="contact-content" class="grid">
            <!-- Dynamic Content -->
        </div>
    </div>

    <!-- ADMIN -->
    <div id="admin" class="page-section">
        <h1>Admin Panel</h1>
        <div class="card">
            <h3>Post News</h3>
            <input type="text" id="news-title" placeholder="Title">
            <textarea id="news-text" rows="4" placeholder="Content"></textarea>
            <button onclick="postNews()">Publish</button>
        </div>
        <div class="card">
            <h3>Audit Log</h3>
            <button onclick="loadAudit()">Refresh</button>
            <table id="audit-table"><thead><tr><th>Type</th><th>Actor</th><th>Time</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="login" class="page-section">
        <h1>Access Control</h1>
        <div class="card" style="max-width: 400px; margin: 0 auto;">
            <input type="text" id="login-user" placeholder="Username">
            <input type="password" id="login-pass" placeholder="Password">
            <button onclick="login()">Sign in</button>
            <p id="login-msg"></p>
        </div>
    </div>

</div>

<!-- SETTINGS MODAL -->
<div id="settings-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Page Settings</h2>
            <span class="close-btn" onclick="closeSettings()">Ã—</span>
        </div>
        <p class="status-err">Only accessible by VendettaPyrex</p>
        
        <div class="card">
            <h3>About Page Content</h3>
            <label>Box 1 Description</label>
            <textarea id="set-about-box1" rows="3"></textarea>
            <label>Box 2 Description</label>
            <textarea id="set-about-box2" rows="3"></textarea>
        </div>
        <div class="card">
            <h3>Contact Page Content</h3>
            <label>Content HTML/Text</label>
            <textarea id="set-contact-content" rows="5"></textarea>
        </div>
        <button onclick="saveSettings()">Save Changes</button>
    </div>
</div>

<script>
    const API_URL = ""; // Leave empty for same origin (Cloudflare Worker)
    let authToken = localStorage.getItem('cid_token');
    let currentUser = null;

    // --- NAVIGATION LOGIC (FIXED OVERLAPPING) ---
    function navigateTo(pageId) {
        // 1. Hide ALL page sections
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        
        // 2. Show ONLY the target section
        const target = document.getElementById(pageId);
        if (target) target.classList.add('active');
        
        // 3. Close any open modals
        closeSettings();

        // 4. Load data specific to page
        if (pageId === 'home') loadNews();
        if (pageId === 'about') loadPageContent();
        if (pageId === 'contact') loadPageContent();
        if (pageId === 'admin') loadAudit();
        
        updateAuthUI();
        window.scrollTo(0,0);
    }

    // --- SETTINGS MODAL LOGIC ---
    function openSettings() {
        if (!authToken) return navigateTo('login');
        document.getElementById('settings-modal').classList.add('active');
        loadSettingsData();
    }
    function closeSettings() {
        document.getElementById('settings-modal').classList.remove('active');
    }

    // --- AUTH ---
    function updateAuthUI() {
        const isAdmin = authToken && currentUser === "VendettaPyrex";
        document.getElementById('nav-admin').classList.toggle('hidden', !isAdmin);
        document.getElementById('nav-settings').classList.toggle('hidden', !isAdmin);
        document.getElementById('nav-logout').classList.toggle('hidden', !isAdmin);
        document.getElementById('nav-login').classList.toggle('hidden', isAdmin);
    }

    async function login() {
        const u = document.getElementById('login-user').value;
        const p = document.getElementById('login-pass').value;
        const msg = document.getElementById('login-msg');
        try {
            const res = await fetch(API_URL + '/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: u, password: p })
            });
            const data = await res.json();
            if (data.ok) {
                authToken = data.token;
                currentUser = u;
                localStorage.setItem('cid_token', authToken);
                msg.textContent = "Login successful";
                msg.className = "status-ok";
                setTimeout(() => navigateTo('home'), 1000);
            } else {
                msg.textContent = data.error;
                msg.className = "status-err";
            }
        } catch (e) {
            msg.textContent = "Connection error";
            msg.className = "status-err";
        }
    }

    function logout() {
        authToken = null;
        currentUser = null;
        localStorage.removeItem('cid_token');
        navigateTo('home');
    }

    // --- SERVER SIDE SETTINGS ---
    async function loadPageContent() {
        // Fetch About
        try {
            const res = await fetch(API_URL + '/pages/about');
            const data = await res.json();
            if (data.ok && data.value) {
                // Expecting format: "Box1Desc|Box2Desc"
                const parts = data.value.split('|');
                if(parts[0]) document.getElementById('about-box1-desc').textContent = parts[0];
                if(parts[1]) document.getElementById('about-box2-desc').textContent = parts[1];
            }
        } catch(e) {}
        
        // Fetch Contact
        try {
            const res = await fetch(API_URL + '/pages/contact');
            const data = await res.json();
            if (data.ok && data.value) {
                document.getElementById('contact-content').innerHTML = data.value;
            }
        } catch(e) {}
    }

    async function loadSettingsData() {
        if (!authToken) return;
        // Load current values into inputs
        try {
            const resAbout = await fetch(API_URL + '/pages/about');
            const dataAbout = await resAbout.json();
            if (dataAbout.ok) {
                const parts = dataAbout.value.split('|');
                document.getElementById('set-about-box1').value = parts[0] || "";
                document.getElementById('set-about-box2').value = parts[1] || "";
            }
        } catch(e) {}

        try {
            const resContact = await fetch(API_URL + '/pages/contact');
            const dataContact = await resContact.json();
            if (dataContact.ok) {
                document.getElementById('set-contact-content').value = dataContact.value || "";
            }
        } catch(e) {}
    }

    async function saveSettings() {
        if (!authToken) return alert("Unauthorized");
        const aboutVal = document.getElementById('set-about-box1').value + "|" + document.getElementById('set-about-box2').value;
        const contactVal = document.getElementById('set-contact-content').value;

        try {
            const res1 = await fetch(API_URL + '/pages/about', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ value: aboutVal })
            });
            const res2 = await fetch(API_URL + '/pages/contact', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ value: contactVal })
            });
            
            if(res1.ok && res2.ok) {
                alert("Settings Saved Server-Side");
                closeSettings();
                navigateTo('about');
            } else {
                alert("Save Failed (Ensure you are VendettaPyrex)");
            }
        } catch (e) {
            alert("Save Failed");
        }
    }

    // --- NEWS & AUDIT ---
    async function loadNews() {
        const res = await fetch(API_URL + '/news');
        const data = await res.json();
        const feed = document.getElementById('news-feed');
        feed.innerHTML = "";
        if (data.ok && data.items.length > 0) {
            data.items.forEach(item => {
                feed.innerHTML += `<div class="card"><h4>${item.title}</h4><p>${item.text}</p><small>${item.createdAt} by ${item.createdBy}</small></div>`;
            });
        } else {
            feed.innerHTML = "<p>No news posted.</p>";
        }
    }

    async function postNews() {
        if (!authToken) return alert("Login required");
        const t = document.getElementById('news-title').value;
        const c = document.getElementById('news-text').value;
        await fetch(API_URL + '/news', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
            body: JSON.stringify({ title: t, text: c })
        });
        loadNews();
        document.getElementById('news-title').value = "";
        document.getElementById('news-text').value = "";
    }

    async function loadAudit() {
        if (!authToken) return;
        const res = await fetch(API_URL + '/audit', {
            headers: { 'Authorization': 'Bearer ' + authToken }
        });
        const data = await res.json();
        const tbody = document.querySelector('#audit-table tbody');
        tbody.innerHTML = "";
        if (data.ok) {
            data.items.forEach(i => {
                tbody.innerHTML += `<tr><td>${i.type}</td><td>${i.actor}</td><td>${i.ts}</td></tr>`;
            });
        }
    }

    // Init
    updateAuthUI();
    loadNews();
</script>
</body>
</html>
