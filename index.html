<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CID Internal Dashboard</title>

<style>
body {
  margin:0;
  font-family:Arial, sans-serif;
  background:#0f1117;
  color:#e6e6e6;
}

header {
  background:#161b22;
  padding:15px;
  font-size:20px;
  font-weight:bold;
  border-bottom:1px solid #2a2f3a;
}

nav {
  display:flex;
  gap:10px;
  padding:10px;
  background:#0d1117;
  border-bottom:1px solid #2a2f3a;
}

button {
  background:#1f6feb;
  color:white;
  border:none;
  padding:8px 12px;
  cursor:pointer;
  border-radius:4px;
}

button.secondary {
  background:#30363d;
}

button.danger {
  background:#da3633;
}

section {
  display:none;
  padding:20px;
}

section.active {
  display:block;
}

input, select {
  padding:6px;
  margin:4px 0;
  background:#161b22;
  color:white;
  border:1px solid #30363d;
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}

th, td {
  border:1px solid #30363d;
  padding:6px;
  text-align:left;
}

th {
  background:#161b22;
}

.status {
  font-weight:bold;
}
</style>
</head>

<body>

<header>CID Internal Dashboard</header>

<nav>
  <button onclick="showSection('loginSection')">Login</button>
  <button onclick="showSection('recruitSection')">Recruitment</button>
  <button onclick="showSection('docsSection')">Docs</button>
  <button onclick="showSection('blacklistSection')">Blacklist</button>
  <button onclick="showSection('trainingSection')">Training</button>
</nav>

<section id="loginSection" class="active">
  <h2>Login</h2>
  <input id="loginUser" placeholder="Username"><br>
  <input id="loginPass" type="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
  <div id="loginStatus"></div>
</section>

<section id="recruitSection">
  <h2>Recruitment</h2>
  <button onclick="loadRecruitment()">Refresh</button>
  <div id="recruitTable"></div>
</section>

<section id="docsSection">
  <h2>Docs</h2>
  <button onclick="loadDocs()">Load Docs</button>
  <div id="docsTable"></div>
</section>

<section id="blacklistSection">
  <h2>Blacklist</h2>
  <button onclick="loadBlacklist()">Load Blacklist</button>
  <div id="blacklistTable"></div>
</section>

<section id="trainingSection">
  <h2>Training Status</h2>
  <input id="trainingUser" placeholder="Username">
  <button onclick="checkTraining()">Check</button>
  <pre id="trainingResult"></pre>
</section>
<script>

const API_BASE = "https://YOUR-WORKER-URL.workers.dev"; 
// ðŸ”¥ REPLACE with your actual worker URL

let authToken = localStorage.getItem("cid_token") || null;

/* =========================
   SECTION SWITCHING
========================= */
function showSection(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* =========================
   AUTH HEADERS
========================= */
function authHeaders(extra={}){
  if(!authToken) return extra;
  return {
    ...extra,
    Authorization: "Bearer " + authToken
  };
}

/* =========================
   API WRAPPER
========================= */
async function api(path, options={}){
  const res = await fetch(API_BASE + path, options);
  const data = await res.json().catch(()=>({}));

  if(!res.ok){
    throw new Error(data.error || "Request failed");
  }

  return data;
}

/* =========================
   LOGIN
========================= */
async function login(){
  const username = document.getElementById("loginUser").value.trim();
  const password = document.getElementById("loginPass").value.trim();
  const status = document.getElementById("loginStatus");

  status.textContent = "Logging in...";

  try{
    const data = await api("/auth/login",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ username,password })
    });

    authToken = data.token;
    localStorage.setItem("cid_token", authToken);

    status.textContent = "Login successful!";
  }catch(e){
    status.textContent = "Error: " + e.message;
  }
}
  /* =========================
   RECRUITMENT
========================= */

async function loadRecruitment(){
  const container = document.getElementById("recruitTable");
  container.innerHTML = "Loading...";

  try{
    const data = await api("/recruitment/list",{
      headers: authHeaders()
    });

    const rows = data.rows || [];

    let html = "<table>";
    html += `
      <tr>
        <th>Row</th>
        <th>Username</th>
        <th>Method</th>
        <th>Status</th>
        <th>Decision</th>
        <th>Actions</th>
      </tr>
    `;

    for(const r of rows){
      html += `
        <tr>
          <td>${r.row}</td>
          <td>${r.username}</td>
          <td>${r.entranceMethod}</td>
          <td class="status">${r.status}</td>
          <td>${r.decision}</td>
          <td>
            <button onclick="setRecruitStatus(${r.row},'COMPLETED')">Complete</button>
            <button onclick="validateRecruit(${r.row},true)">Approve</button>
            <button class="danger" onclick="validateRecruit(${r.row},false)">Deny</button>
          </td>
        </tr>
      `;
    }

    html += "</table>";
    container.innerHTML = html;

  }catch(e){
    container.innerHTML = "Error: " + e.message;
  }
}

async function setRecruitStatus(row,status){
  try{
    await api("/recruitment/set_status",{
      method:"POST",
      headers: authHeaders({ "Content-Type":"application/json" }),
      body: JSON.stringify({ row,status })
    });

    loadRecruitment();
  }catch(e){
    alert(e.message);
  }
}

async function validateRecruit(row,approved){
  try{
    await api("/recruitment/validate",{
      method:"POST",
      headers: authHeaders({ "Content-Type":"application/json" }),
      body: JSON.stringify({
        row,
        decision: approved ? "APPROVED" : "DENIED"
      })
    });

    loadRecruitment();
  }catch(e){
    alert(e.message);
  }
}
  /* =========================
   DOCS
========================= */

async function loadDocs(){
  const container = document.getElementById("docsTable");
  container.innerHTML = "Loading...";

  try{
    const data = await api("/google/docs",{
      headers: authHeaders()
    });

    const docs = data.docs || [];

    let html = "<table>";
    html += `
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Type</th>
        <th>Permissions</th>
      </tr>
    `;

    for(const d of docs){
      html += `
        <tr>
          <td>${d.id}</td>
          <td>${d.name}</td>
          <td>${d.type}</td>
          <td>
            <button onclick="loadPermissions('${d.id}')">
              View Permissions
            </button>
          </td>
        </tr>
      `;
    }

    html += "</table>";
    container.innerHTML = html;

  }catch(e){
    container.innerHTML = "Error: " + e.message;
  }
}

async function loadPermissions(id){
  const container = document.getElementById("docsTable");
  container.innerHTML = "Loading permissions...";

  try{
    const data = await api(`/google/docs/permissions?id=${id}`,{
      headers: authHeaders()
    });

    const perms = data.permissions || [];

    let html = `<h3>Permissions for ${data.name}</h3>`;
    html += "<table>";
    html += `
      <tr>
        <th>Email</th>
        <th>Role</th>
        <th>Action</th>
      </tr>
    `;

    for(const p of perms){
      html += `
        <tr>
          <td>${p.email}</td>
          <td>${p.role}</td>
          <td>
            <button class="danger"
              onclick="revokeDoc('${id}','${p.email}')">
              Revoke
            </button>
          </td>
        </tr>
      `;
    }

    html += "</table>";
    html += `
      <br>
      <input id="grantEmail" placeholder="Email">
      <select id="grantRole">
        <option value="reader">Reader</option>
        <option value="writer">Writer</option>
        <option value="commenter">Commenter</option>
      </select>
      <button onclick="grantDoc('${id}')">Grant</button>
      <br><br>
      <button onclick="loadDocs()">Back</button>
    `;

    container.innerHTML = html;

  }catch(e){
    container.innerHTML = "Error: " + e.message;
  }
}

async function grantDoc(id){
  const email = document.getElementById("grantEmail").value.trim();
  const role = document.getElementById("grantRole").value;

  if(!email){
    alert("Enter email");
    return;
  }

  try{
    await api("/google/grant",{
      method:"POST",
      headers: authHeaders({ "Content-Type":"application/json" }),
      body: JSON.stringify({ email,id,role })
    });

    loadPermissions(id);
  }catch(e){
    alert(e.message);
  }
}

async function revokeDoc(id,email){
  try{
    await api("/google/revoke",{
      method:"POST",
      headers: authHeaders({ "Content-Type":"application/json" }),
      body: JSON.stringify({ email,id })
    });

    loadPermissions(id);
  }catch(e){
    alert(e.message);
  }
}
  /* =========================
   BLACKLIST
========================= */

async function loadBlacklist(){
  const container = document.getElementById("blacklistTable");
  container.innerHTML = "Loading...";

  try{
    const data = await api("/blacklist",{
      headers: authHeaders()
    });

    const items = data.items || [];

    let html = "<table>";
    html += `
      <tr>
        <th>Username</th>
        <th>Reason</th>
        <th>Added By</th>
        <th>Action</th>
      </tr>
    `;

    for(const item of items){
      html += `
        <tr>
          <td>${item.username}</td>
          <td>${item.reason}</td>
          <td>${item.addedBy}</td>
          <td>
            <button class="danger"
              onclick="removeBlacklist('${item.username}')">
              Remove
            </button>
          </td>
        </tr>
      `;
    }

    html += "</table>";
    html += `
      <br>
      <input id="blUser" placeholder="Username">
      <input id="blReason" placeholder="Reason">
      <button onclick="addBlacklist()">Add</button>
    `;

    container.innerHTML = html;

  }catch(e){
    container.innerHTML = "Error: " + e.message;
  }
}

async function addBlacklist(){
  const username = document.getElementById("blUser").value.trim();
  const reason = document.getElementById("blReason").value.trim();

  if(!username || !reason){
    alert("Fill all fields");
    return;
  }

  try{
    await api("/blacklist/add",{
      method:"POST",
      headers: authHeaders({ "Content-Type":"application/json" }),
      body: JSON.stringify({ username,reason })
    });

    loadBlacklist();
  }catch(e){
    alert(e.message);
  }
}

async function removeBlacklist(username){
  try{
    await api("/blacklist/remove",{
      method:"POST",
      headers: authHeaders({ "Content-Type":"application/json" }),
      body: JSON.stringify({ username })
    });

    loadBlacklist();
  }catch(e){
    alert(e.message);
  }
}

/* =========================
   TRAINING STATUS
========================= */

async function checkTraining(){
  const username = document.getElementById("trainingUser").value.trim();
  const output = document.getElementById("trainingResult");

  if(!username){
    alert("Enter username");
    return;
  }

  output.textContent = "Loading...";

  try{
    const data = await api("/sheet/trainingstatus",{
      method:"POST",
      headers: authHeaders({ "Content-Type":"application/json" }),
      body: JSON.stringify({ username })
    });

    output.textContent = JSON.stringify(data,null,2);

  }catch(e){
    output.textContent = "Error: " + e.message;
  }
}

</script>
</body>
</html>
