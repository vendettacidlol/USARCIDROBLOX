<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CID Terminal</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <style>
    :root{
      --bg:#050607; --fg:#d7fbe6; --muted:#8fb3a3; --accent:#6ee7b7; --danger:#ff6b6b;
      --border:rgba(215,251,230,0.14);
    }
    html, body { height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      overflow:auto;
    }
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;box-sizing:border-box;}
    .terminal{
      width:min(1100px,100%);
      height:min(820px, calc(100vh - 36px));
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.00));
      box-shadow: 0 0 0 1px rgba(110,231,183,0.08), 0 30px 80px rgba(0,0,0,0.55);
      position:relative;
      display:flex;
      flex-direction:column;
    }
    .bar{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(215,251,230,0.12);background:rgba(0,0,0,0.35);flex:0 0 auto;}
    .dots{display:flex;gap:6px;}
    .dot{width:10px;height:10px;border-radius:999px;opacity:.75}
    .dot.red{background:#ff5f57}.dot.yellow{background:#febc2e}.dot.green{background:#28c840}
    .title{color:var(--muted);font-size:13px;}
    .content{flex:1 1 auto;min-height:0;display:grid;grid-template-columns:1fr 460px;gap:12px;padding:12px;box-sizing:border-box;}
    .screen{
      background:rgba(0,0,0,0.30);
      border:1px solid rgba(215,251,230,0.10);
      border-radius:10px;
      padding:12px;
      overflow:auto;
      white-space:pre-wrap;
      line-height:1.35;
      font-size:14px;
      user-select:text;
      min-height:0;
    }
    .right{display:flex;flex-direction:column;gap:12px;min-width:0;min-height:0;overflow:auto;padding-right:4px;}
    .panel{background:rgba(0,0,0,0.30);border:1px solid rgba(215,251,230,0.10);border-radius:10px;overflow:hidden;min-width:0;display:flex;flex-direction:column;min-height:0;flex:0 0 auto;}
    .panel .hd{padding:10px 12px;border-bottom:1px solid rgba(215,251,230,0.10);color:var(--muted);font-size:13px;background:rgba(0,0,0,0.18);display:flex;justify-content:space-between;align-items:center;flex:0 0 auto;}
    .panel .bd{padding:10px 12px;overflow:auto;min-height:260px;max-height:360px;}
    .watermark{position:absolute;right:10px;bottom:10px;color:rgba(215,251,230,0.18);font-weight:800;pointer-events:none;user-select:none;}
    .promptline{display:flex;gap:10px;align-items:baseline;}
    .prompt{color:var(--accent);}
    input.term{flex:1;background:transparent;border:none;outline:none;color:var(--fg);font:inherit;padding:0;margin:0;caret-color:var(--accent);}
    .chip{display:inline-block;padding:2px 8px;border:1px solid rgba(215,251,230,0.18);border-radius:999px;font-size:12px;color:var(--muted);white-space:nowrap;}
    .muted{color:var(--muted)}
    .danger{color:var(--danger)}
    @media (max-width:980px){
      .terminal{height:auto; min-height: calc(100vh - 36px);}
      .content{grid-template-columns:1fr;}
      .right{max-height:none;}
      .panel .bd{max-height:none;}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="terminal">
    <div class="bar">
      <div class="dots"><div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div></div>
      <div class="title">Criminal Investigation Division — BGC Terminal</div>
    </div>

    <div class="content">
      <div id="screen" class="screen"></div>

      <div class="right">
        <div class="panel">
          <div class="hd"><span>Chart</span><span id="chartStatus" class="chip">idle</span></div>
          <div class="bd"><canvas id="chart" height="240"></canvas></div>
        </div>
      </div>
    </div>

    <div class="watermark">Criminal Investigation Division</div>
  </div>
</div>

<script>
const API_BASE = "https://the.chastiefola.workers.dev"; // <-- your Worker

const screen = document.getElementById("screen");
const chartStatus = document.getElementById("chartStatus");

function termPrint(text="", cls=null){
  const div = document.createElement("div");
  if (cls) div.className = cls;
  div.textContent = text;
  screen.appendChild(div);
  screen.scrollTop = screen.scrollHeight;
}

function promptLine(label, isPassword=false){
  const row = document.createElement("div");
  row.className = "promptline";
  const p = document.createElement("span");
  p.className = "prompt";
  p.textContent = label;
  row.appendChild(p);

  const input = document.createElement("input");
  input.className = "term";
  input.autocomplete = "off";
  input.spellcheck = false;
  input.type = isPassword ? "password" : "text";
  row.appendChild(input);

  screen.appendChild(row);
  input.focus();
  screen.scrollTop = screen.scrollHeight;

  return new Promise((resolve)=>{
    input.addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){
        const val = input.value;
        row.removeChild(input);
        const shown = document.createElement("span");
        shown.textContent = isPassword ? "•".repeat(Math.min(16, val.length)) : val;
        row.appendChild(shown);
        resolve(val);
      }
    });
  });
}

let TOKEN = null;
let IS_ADMIN = false;

function authHeaders(extra={}) {
  return { ...(TOKEN ? { "Authorization": `Bearer ${TOKEN}` } : {}), ...extra };
}

async function api(path, opts={}) {
  const res = await fetch(`${API_BASE}${path}`, opts);
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || data.ok === false) throw new Error(data.error || `HTTP ${res.status}`);
  return data;
}

async function workerLogin(username, password){
  const data = await api(`/auth/login`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ username, password })
  });
  TOKEN = data.token;
  IS_ADMIN = !!data.isAdmin;
}

let chart;
(function initChart(){
  const ctx = document.getElementById("chart").getContext("2d");
  chart = new Chart(ctx, {
    type: "line",
    data: { datasets: [{ label: "Series", data: [], pointRadius: 2, tension: 0.2 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      parsing: false,
      scales: {
        x: { type: "time", time: { unit: "day" }, ticks: { color: "#8fb3a3" }, grid: { color: "rgba(215,251,230,0.08)" } },
        y: { ticks: { color: "#8fb3a3" }, grid: { color: "rgba(215,251,230,0.08)" } }
      },
      plugins: { legend: { labels: { color: "#8fb3a3" } } }
    }
  });
})();

function setSeries(label, points){
  chart.data.datasets[0].label = label;
  chart.data.datasets[0].data = points;
  chart.update();
}

async function cmdMemberHistory(){
  const data = await api(`/roblox/groupmemberhistory`, { headers: authHeaders() });
  const pts = (data.points || [])
    .map(p => ({ x: new Date(p.date), y: Number(p.count) }))
    .filter(p => !isNaN(p.x.getTime()) && Number.isFinite(p.y))
    .sort((a,b)=> a.x - b.x);

  setSeries(`Members — ${data.groupName || "Group"}`, pts);
  chartStatus.textContent = "members";
  termPrint(`Logged/Loaded ${pts.length} points. Latest: ${data.latest?.date} = ${data.latest?.count}`);
}

async function cmdTrainingStatus(user){
  const data = await api(`/sheet/trainingstatus`, {
    method:"POST",
    headers: authHeaders({ "Content-Type":"application/json" }),
    body: JSON.stringify({ username: user })
  });
  if (!data.found){ termPrint(`trainingstatus: ${user} not found.`); return; }
  termPrint(`TRAINING STATUS — ${user}`);
  termPrint(`Rank: ${data.rank}`);
  termPrint(`Position: ${data.position}`);
  termPrint(`Timezone: ${data.timezone}`);
  termPrint(`Current Phase: ${data.currentPhase}`);
  termPrint(`Entry Date: ${data.entryDate}`);
  termPrint(`Date of Expiry: ${data.dateOfExpiry}`);
  termPrint(`Designated Unit: ${data.designatedUnit}`);
  termPrint(`Notes: ${data.notes}`);
}

async function cmdSicTrainingStatus(user){
  const data = await api(`/sheet/sictrainingstatus`, {
    method:"POST",
    headers: authHeaders({ "Content-Type":"application/json" }),
    body: JSON.stringify({ username: user })
  });
  if (!data.found){ termPrint(`sictrainingstatus: ${user} not found.`); return; }
  termPrint(`SIC TRAINING STATUS — ${user}`);
  termPrint(`Rank: ${data.rank}`);
  termPrint(`Position: ${data.position}`);
  termPrint(`Timezone: ${data.timezone}`);
  termPrint(`Training Status: ${data.trainingStatus}`);
  termPrint(`Entry Date: ${data.entryDate}`);
  termPrint(`Designated Unit: ${data.designatedUnit}`);
}

// Admin-only
async function cmdDocs(){
  const data = await api(`/google/docs`, { headers: authHeaders() });
  termPrint("Documents available:");
  for (const d of data.docs) termPrint(`- ID ${d.id}: ${d.name}`);
}
async function cmdWhoHas(id){
  const data = await api(`/google/docs/permissions?id=${encodeURIComponent(id)}`, { headers: authHeaders() });
  termPrint(`Access list for ID ${data.id} — ${data.name}`);
  if (!data.permissions.length){ termPrint("(No user permissions found)"); return; }
  for (const p of data.permissions) termPrint(`- ${p.email} (${p.role})`);
}
async function cmdGrant(email, id){
  const data = await api(`/google/grant`, {
    method:"POST",
    headers: authHeaders({ "Content-Type":"application/json" }),
    body: JSON.stringify({ email, id })
  });
  termPrint(`GRANTED: ${data.email} → ${data.name} (ID ${data.docId})`);
}
async function cmdRevoke(email, id){
  const data = await api(`/google/revoke`, {
    method:"POST",
    headers: authHeaders({ "Content-Type":"application/json" }),
    body: JSON.stringify({ email, id })
  });
  termPrint(data.removed
    ? `REVOKED: ${email} from ${data.name} (ID ${data.docId})`
    : `REVOKE: ${email} had no access to ${data.name} (ID ${data.docId})`);
}
async function cmdRevokeAll(email){
  const data = await api(`/google/revoke_all`, {
    method:"POST",
    headers: authHeaders({ "Content-Type":"application/json" }),
    body: JSON.stringify({ email })
  });
  termPrint(`REVOKE ALL for ${email}:`);
  for (const r of data.results) termPrint(`- ${r.id} ${r.name}: ${r.removed ? "REMOVED" : "NO CHANGE"}`);
}

function printHelp(){
  termPrint("Commands:");
  termPrint("  memberhistory");
  termPrint("  trainingstatus <USERNAME>");
  termPrint("  sictrainingstatus <USERNAME>");
  termPrint("  logout");
  termPrint("  help");
  if (IS_ADMIN){
    termPrint("");
    termPrint("Admin Commands:");
    termPrint("  docs");
    termPrint("  whohas <ID>");
    termPrint("  grant <email> <ID>");
    termPrint("  revoke <email> <ID>");
    termPrint("  revoke all <email>");
  }
}

async function boot(){
  termPrint("CID Secure Console v1.0");
  termPrint("Authorized personnel only.");
  termPrint("");

  while(true){
    termPrint("Login required.");
    const u = await promptLine("login> ");
    const p = await promptLine("password> ", true);
    try{
      await workerLogin(u, p);
      termPrint("");
      termPrint(`ACCESS GRANTED${IS_ADMIN ? " (ADMIN)" : ""}`);
      termPrint("");
      break;
    } catch(e){
      termPrint("");
      termPrint("ACCESS DENIED", "danger");
      termPrint("Reason: " + e.message, "muted");
      termPrint("");
    }
  }

  printHelp();
  termPrint("");

  while(true){
    const cmd = await promptLine("cid> ");
    const parts = cmd.trim().split(/\s+/).filter(Boolean);
    if (!parts.length) continue;

    const base = parts[0].toLowerCase();

    try{
      if (base === "help"){ printHelp(); continue; }
      if (base === "logout"){ TOKEN = null; IS_ADMIN = false; termPrint("Logged out. Refresh to log in again."); continue; }

      if (base === "memberhistory"){ await cmdMemberHistory(); continue; }

      if (base === "trainingstatus"){
        const user = parts.slice(1).join(" ");
        if (!user){ termPrint("Usage: trainingstatus <USERNAME>"); continue; }
        await cmdTrainingStatus(user); continue;
      }

      if (base === "sictrainingstatus"){
        const user = parts.slice(1).join(" ");
        if (!user){ termPrint("Usage: sictrainingstatus <USERNAME>"); continue; }
        await cmdSicTrainingStatus(user); continue;
      }

      if (base === "docs"){
        if (!IS_ADMIN){ termPrint("Unknown command.", "danger"); continue; }
        await cmdDocs(); continue;
      }
      if (base === "whohas"){
        if (!IS_ADMIN){ termPrint("Unknown command.", "danger"); continue; }
        const id = parts[1]; if (!id){ termPrint("Usage: whohas <ID>"); continue; }
        await cmdWhoHas(id); continue;
      }
      if (base === "grant"){
        if (!IS_ADMIN){ termPrint("Unknown command.", "danger"); continue; }
        const email = parts[1], id = parts[2];
        if (!email || !id){ termPrint("Usage: grant <email> <ID>"); continue; }
        await cmdGrant(email, id); continue;
      }
      if (base === "revoke"){
        if (!IS_ADMIN){ termPrint("Unknown command.", "danger"); continue; }

        if ((parts[1]||"").toLowerCase() === "all"){
          const email = parts[2];
          if (!email){ termPrint("Usage: revoke all <email>"); continue; }
          await cmdRevokeAll(email); continue;
        }

        const email = parts[1], id = parts[2];
        if (!email || !id){ termPrint("Usage: revoke <email> <ID>"); continue; }
        await cmdRevoke(email, id); continue;
      }

      termPrint(`Unknown command: ${base}`, "danger");
    } catch(e){
      termPrint(`ERROR: ${e.message}`, "danger");
    }
  }
}
boot();
</script>
</body>
</html>
