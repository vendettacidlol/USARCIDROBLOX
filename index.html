<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secure Investigations Portal</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <style>
    :root{
      --bg:#050607; --fg:#d7fbe6; --muted:#8fb3a3; --accent:#6ee7b7; --danger:#ff6b6b;
      --border:rgba(215,251,230,0.14);

      --portal-ink:#0a1626;
      --portal-ink-2:#0e223a;
      --portal-gold:#c7a44a;
      --portal-line:rgba(255,255,255,0.14);
      --portal-text:#eaf0ff;
      --portal-sub:#b7c4df;
    }

    html, body { height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 900px at 20% -10%, rgba(199,164,74,0.18), transparent 55%),
                  radial-gradient(900px 700px at 110% 20%, rgba(82,140,255,0.14), transparent 55%),
                  linear-gradient(180deg, var(--portal-ink), #06080c 65%, var(--bg));
      color: var(--portal-text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      overflow:auto;
    }

    .banner{
      background: rgba(0,0,0,0.35);
      border-bottom: 1px solid var(--portal-line);
      padding: 8px 14px;
      font-size: 13px;
      color: var(--portal-sub);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .banner b{ color: var(--portal-text); font-weight: 650; }
    .banner .pill{
      border:1px solid rgba(199,164,74,0.35);
      color: rgba(255,255,255,0.85);
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(199,164,74,0.08);
      white-space: nowrap;
    }

    header{
      background: linear-gradient(180deg, rgba(14,34,58,0.92), rgba(10,22,38,0.92));
      border-bottom: 1px solid var(--portal-line);
      box-shadow: 0 16px 50px rgba(0,0,0,0.35);
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(8px);
    }
    .header-inner{
      max-width: 1180px;
      margin: 0 auto;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 240px;
    }
    .brand-mark{
      width: 42px;
      height: 42px;
      border-radius: 10px;
      background: linear-gradient(145deg, rgba(199,164,74,0.30), rgba(199,164,74,0.08));
      border: 1px solid rgba(199,164,74,0.35);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.35) inset, 0 14px 40px rgba(0,0,0,0.28);
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,0.92);
      font-weight: 800;
      letter-spacing: 0.5px;
      user-select:none;
    }
    .brand-title{ line-height:1.1; }
    .brand-title .top{
      font-weight: 800;
      letter-spacing: 0.4px;
      color: var(--portal-text);
      font-size: 16px;
    }
    .brand-title .sub{
      font-size: 12px;
      color: var(--portal-sub);
      margin-top: 4px;
    }

    nav{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .navbtn{
      appearance:none;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      border-radius: 10px;
      padding: 9px 12px;
      font-size: 13px;
      font-weight: 650;
      letter-spacing: 0.2px;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      white-space: nowrap;
    }
    .navbtn:hover{
      background: rgba(255,255,255,0.09);
      border-color: rgba(199,164,74,0.32);
    }
    .navbtn:active{ transform: translateY(1px); }
    .navbtn.primary{
      border-color: rgba(199,164,74,0.45);
      background: rgba(199,164,74,0.10);
    }
    .navbtn[hidden]{ display:none !important; }

    .container{
      max-width: 1180px;
      margin: 0 auto;
      padding: 18px 16px 26px;
      box-sizing: border-box;
    }

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      align-items:start;
    }

    .grid.toolmode{
      grid-template-columns: 1fr;
    }
    .grid.toolmode #homeCard{
      display:none;
    }

    .card{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      box-shadow: 0 24px 70px rgba(0,0,0,0.40);
      overflow:hidden;
    }
    .card .hd{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .card .hd .title{
      font-weight: 800;
      letter-spacing: 0.25px;
      font-size: 14px;
      color: rgba(255,255,255,0.92);
    }
    .card .hd .tag{
      font-size: 12px;
      color: rgba(255,255,255,0.82);
      border: 1px solid rgba(199,164,74,0.35);
      background: rgba(199,164,74,0.08);
      border-radius: 999px;
      padding: 3px 10px;
      white-space: nowrap;
    }
    .card .bd{
      padding: 14px;
      color: rgba(255,255,255,0.88);
    }

    .note{
      color: var(--portal-sub);
      font-size: 13px;
      line-height: 1.35;
    }

    .field{ display:flex; flex-direction:column; gap: 7px; margin-top: 12px; }
    label{ font-size: 12px; color: rgba(255,255,255,0.82); font-weight: 650; letter-spacing: 0.2px; }
    input.portal, textarea.portal{
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.22);
      color: rgba(255,255,255,0.92);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }
    textarea.portal{ min-height: 110px; resize: vertical; }
    input.portal:focus, textarea.portal:focus{
      border-color: rgba(199,164,74,0.40);
      box-shadow: 0 0 0 4px rgba(199,164,74,0.10);
    }
    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      margin-top: 14px;
      flex-wrap: wrap;
    }
    .status{
      font-size: 13px;
      color: var(--portal-sub);
      min-height: 18px;
    }
    .status.danger{ color: var(--danger); }
    .status.ok{ color: rgba(110,231,183,0.92); }

    .news{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .newsItem{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .newsItem .h{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .newsItem .t{ font-weight: 800; color: rgba(255,255,255,0.92); }
    .newsItem .d{ font-size: 12px; color: rgba(255,255,255,0.75); }
    .newsItem .b{ margin-top: 6px; color: rgba(255,255,255,0.86); font-size: 13px; line-height: 1.35; white-space: pre-wrap; }

    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 50;
      padding: 18px;
      box-sizing: border-box;
    }
    .modalBack.show{ display:flex; }
    .modal{
      width: min(560px, 100%);
      background: rgba(10,22,38,0.96);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 16px;
      box-shadow: 0 30px 90px rgba(0,0,0,0.60);
      overflow:hidden;
    }
    .modal .mh{
      padding: 12px 14px;
      background: rgba(0,0,0,0.25);
      border-bottom: 1px solid rgba(255,255,255,0.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .modal .mh .mt{ font-weight: 900; }
    .modal .mb{ padding: 14px; }

    .wrap{min-height:0;display:flex;align-items:flex-start;justify-content:center;padding:0;box-sizing:border-box;}
    .terminal{
      width:100%;
      height: min(860px, calc(100vh - 210px));
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.00));
      box-shadow: 0 0 0 1px rgba(110,231,183,0.08), 0 30px 80px rgba(0,0,0,0.55);
      position:relative;
      display:flex;
      flex-direction:column;
    }
    .bar{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(215,251,230,0.12);
      background:rgba(0,0,0,0.35);
      flex:0 0 auto;
    }
    .dots{display:flex;gap:6px;}
    .dot{width:10px;height:10px;border-radius:999px;opacity:.75}
    .dot.red{background:#ff5f57}.dot.yellow{background:#febc2e}.dot.green{background:#28c840}
    .title-mono{color:var(--muted);font-size:13px;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
    .content{
      flex:1 1 auto;
      min-height:0;
      display:grid;
      grid-template-columns: 1fr 460px;
      gap:12px;
      padding:12px;
      box-sizing:border-box;
    }
    .screen{
      background:rgba(0,0,0,0.30);
      border:1px solid rgba(215,251,230,0.10);
      border-radius:10px;
      padding:12px;
      overflow:auto;
      white-space:pre-wrap;
      line-height:1.35;
      font-size:14px;
      user-select:text;
      min-height:0;
      color: var(--fg);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    .right{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
      min-height:0;
      overflow:auto;
      padding-right:4px;
    }
    .panel{
      background:rgba(0,0,0,0.30);
      border:1px solid rgba(215,251,230,0.10);
      border-radius:10px;
      overflow:hidden;
      min-width:0;
      display:flex;
      flex-direction:column;
      min-height:0;
      flex:0 0 auto;
      color: var(--fg);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    .panel .hd{
      padding:10px 12px;
      border-bottom:1px solid rgba(215,251,230,0.10);
      color:var(--muted);
      font-size:13px;
      background:rgba(0,0,0,0.18);
      display:flex;justify-content:space-between;align-items:center;
      flex:0 0 auto;
    }
    .panel .bd{
      padding:10px 12px;
      overflow:auto;
      min-height:120px;
      max-height:240px;
      color: var(--fg);
    }
    .panel.chart .bd{
      min-height:260px;
      max-height:320px;
    }
    .watermark{
      position:absolute;right:10px;bottom:10px;
      color:rgba(215,251,230,0.18);
      font-weight:800;
      pointer-events:none;
      user-select:none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","CourierNew", monospace;
    }
    .promptline{display:flex;gap:10px;align-items:baseline;}
    .prompt{color:var(--accent);}
    input.term{
      flex:1;background:transparent;border:none;outline:none;color:var(--fg);font:inherit;
      padding:0;margin:0;caret-color:var(--accent);
    }
    .chip{
      display:inline-block;padding:2px 8px;border:1px solid rgba(215,251,230,0.18);
      border-radius:999px;font-size:12px;color:var(--muted);
      white-space:nowrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    .kv{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;}
    .list{margin:0;padding-left:18px;}
    .muted{color:var(--muted)}
    .danger{color:var(--danger)}

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .terminal{ height:auto; min-height: 700px; }
      .content{grid-template-columns:1fr;}
      .right{max-height:none;}
      .panel .bd{max-height:none;}
      .grid.toolmode #homeCard{ display:none; }
    }
  </style>
</head>

<body>
  <div class="banner">
    <div><b>Secure Investigations Portal</b> — demo/internal tool UI</div>
    <div class="pill">No seals • No official branding</div>
  </div>

  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="brand-mark">SI</div>
        <div class="brand-title">
          <div class="top">Investigations Division Portal</div>
          <div class="sub">Prevent • Investigate • Educate (internal)</div>
        </div>
      </div>

      <nav>
        <button class="navbtn" id="navHome">Home</button>
        <button class="navbtn" id="navAbout">About</button>
        <button class="navbtn" id="navContact">Contact</button>

        <button class="navbtn" id="navNewsletter">Newsletter</button>
        <button class="navbtn" id="navLogin">Login</button>

        <button class="navbtn primary" id="navTool" hidden>CID Terminal</button>
        <button class="navbtn primary" id="navAdmin" hidden>Admin</button>
        <button class="navbtn" id="navLogout" hidden>Logout</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="grid" id="grid">
      <section class="card" id="homeCard">
        <div class="hd">
          <div class="title">Access Control</div>
          <div class="tag">Authorized Users Only</div>
        </div>
        <div class="bd">
          <form id="loginForm" autocomplete="off">
            <div class="field">
              <label for="loginUser">Username</label>
              <input class="portal" id="loginUser" type="text" required />
            </div>
            <div class="field">
              <label for="loginPass">Password</label>
              <input class="portal" id="loginPass" type="password" required />
            </div>
            <div class="row">
              <button class="navbtn primary" type="submit" id="loginBtn">Sign in</button>
              <div class="status" id="loginStatus"></div>
            </div>
          </form>
        </div>
      </section>

      <section class="card" id="contentCard">
        <div class="hd">
          <div class="title" id="contentTitle">Home</div>
          <div class="tag" id="contentTag">Portal Overview</div>
        </div>

        <div class="bd" id="contentBody">
          <div id="homeView">
            <div class="note"><b>Front Page News</b></div>
            <div class="news" id="newsList"></div>
            <div class="note" id="newsEmpty" style="margin-top:8px; display:none;">No news posted.</div>
          </div>

          <div id="aboutView" hidden>
            <div class="note">About page.</div>
          </div>

          <div id="contactView" hidden>
            <div class="note">Contact page.</div>
          </div>

          <div id="adminView" hidden>
            <div class="field">
              <label for="newsTitle">Title</label>
              <input class="portal" id="newsTitle" type="text" />
            </div>
            <div class="field">
              <label for="newsBody">Body</label>
              <textarea class="portal" id="newsBody"></textarea>
            </div>
            <div class="row">
              <button class="navbtn primary" id="btnAddNews" type="button">Add News</button>
              <div class="status" id="adminStatus"></div>
            </div>
            <div class="news" id="adminNewsList" style="margin-top:14px;"></div>
          </div>

          <div id="toolView" hidden style="margin-top:0;">
            <div class="wrap">
              <div class="terminal">
                <div class="bar">
                  <div class="dots">
                    <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
                  </div>
                  <div class="title-mono">Criminal Investigation Division — BGC Terminal</div>
                </div>

                <div class="content">
                  <div id="screen" class="screen"></div>

                  <div class="right">
                    <div class="panel chart">
                      <div class="hd"><span>Badge Chart</span><span id="chartStatus" class="chip">idle</span></div>
                      <div class="bd"><canvas id="chart" height="240"></canvas></div>
                    </div>

                    <div class="panel">
                      <div class="hd"><span>Blacklist Status</span><span id="blStatus" class="chip">—</span></div>
                      <div class="bd" id="blacklistsBox" class="muted">Run <span class="chip">check &lt;username&gt;</span></div>
                    </div>

                    <div class="panel">
                      <div class="hd"><span>Inventory (No Prices)</span><span id="invStatus" class="chip">—</span></div>
                      <div class="bd" id="inventoryBox" class="muted">Run <span class="chip">check &lt;username&gt;</span></div>
                    </div>
                  </div>
                </div>

                <div class="watermark">Investigations Division</div>
              </div>
            </div>
          </div>

        </div>
      </section>
    </div>
  </main>

  <div class="modalBack" id="newsletterBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mh">
        <div class="mt">Newsletter</div>
        <button class="navbtn" id="closeNewsletter">Close</button>
      </div>
      <div class="mb">
        <div class="field">
          <label for="nlEmail">Email</label>
          <input class="portal" id="nlEmail" type="email" />
        </div>
        <div class="row">
          <button class="navbtn primary" id="nlSubmit" type="button">Subscribe</button>
          <div class="status" id="nlStatus"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG
   ========================= */
const TOOL_API_BASE = "https://the.chastiefola.workers.dev";
const NEWS_API_BASE = "https://YOUR-NEWS-WORKER.your-subdomain.workers.dev";
const ADMIN_USERNAME = "VendettaPyrex";

/* =========================
   PORTAL STATE
   ========================= */
let TOOL_TOKEN = null;
let TOOL_IS_ADMIN = false;
let LOGGED_IN_USER = null;

let NEWS_TOKEN = null;

/* =========================
   COMMON HELPERS
   ========================= */
function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function fmtDate(iso){
  const d = new Date(iso);
  if (isNaN(d.getTime())) return "";
  return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
}

/* =========================
   TOOL API (existing worker)
   ========================= */
function toolAuthHeaders(extra={}) {
  return { ...(TOOL_TOKEN ? { "Authorization": `Bearer ${TOOL_TOKEN}` } : {}), ...extra };
}
async function toolApi(path, opts={}){
  const res = await fetch(`${TOOL_API_BASE}${path}`, opts);
  const data = await res.json().catch(()=> ({}));
  if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
  if (data && data.ok === false) throw new Error(data.error || "Request failed");
  return data;
}
async function toolLogin(username, password){
  const data = await toolApi(`/auth/login`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ username, password })
  });
  TOOL_TOKEN = data.token;
  TOOL_IS_ADMIN = !!data.isAdmin;
  LOGGED_IN_USER = username;
}
async function toolLogCommand(cmdString){
  try{
    await toolApi(`/log/command`, {
      method:"POST",
      headers: toolAuthHeaders({ "Content-Type":"application/json" }),
      body: JSON.stringify({ command: cmdString })
    });
  } catch {}
}

/* =========================
   NEWS API (separate worker)
   ========================= */
function newsAuthHeaders(extra={}) {
  return { ...(NEWS_TOKEN ? { "Authorization": `Bearer ${NEWS_TOKEN}` } : {}), ...extra };
}
async function newsApi(path, opts={}){
  const res = await fetch(`${NEWS_API_BASE}${path}`, opts);
  const data = await res.json().catch(()=> ({}));
  if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
  if (data && data.ok === false) throw new Error(data.error || "Request failed");
  return data;
}
async function newsLogin(username, password){
  const data = await newsApi(`/auth/login`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ username, password })
  });
  NEWS_TOKEN = data.token;
}
async function fetchNewsPublic(){
  const res = await fetch(`${NEWS_API_BASE}/news`);
  const data = await res.json().catch(()=> ({}));
  if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
  return data.items || [];
}
async function createNews(title, text){
  const data = await newsApi(`/news`, {
    method:"POST",
    headers: newsAuthHeaders({ "Content-Type":"application/json" }),
    body: JSON.stringify({ title, text })
  });
  return data.item;
}
async function deleteNews(id){
  const data = await newsApi(`/news/${encodeURIComponent(id)}`, {
    method:"DELETE",
    headers: newsAuthHeaders()
  });
  return !!data.removed;
}

/* =========================
   NEWS UI
   ========================= */
const newsListEl = document.getElementById("newsList");
const newsEmptyEl = document.getElementById("newsEmpty");
const adminNewsListEl = document.getElementById("adminNewsList");
const adminStatusEl = document.getElementById("adminStatus");

function renderNewsHome(items){
  newsListEl.innerHTML = "";
  if (!items.length){
    newsEmptyEl.style.display = "block";
    return;
  }
  newsEmptyEl.style.display = "none";

  for (const n of items.slice(0, 8)){
    const div = document.createElement("div");
    div.className = "newsItem";
    div.innerHTML = `
      <div class="h">
        <div class="t">${escapeHtml(n.title || "Untitled")}</div>
        <div class="d">${escapeHtml(fmtDate(n.createdAt))}</div>
      </div>
      <div class="b">${escapeHtml(n.text || "")}</div>
    `;
    newsListEl.appendChild(div);
  }
}

function renderNewsAdmin(items){
  adminNewsListEl.innerHTML = "";

  for (const n of items){
    const div = document.createElement("div");
    div.className = "newsItem";
    div.innerHTML = `
      <div class="h">
        <div class="t">${escapeHtml(n.title || "Untitled")}</div>
        <div class="d">${escapeHtml(fmtDate(n.createdAt))}</div>
      </div>
      <div class="b">${escapeHtml(n.text || "")}</div>
      <div style="margin-top:10px; display:flex; justify-content:flex-end;">
        <button class="navbtn" data-del="${escapeHtml(n.id)}">Delete</button>
      </div>
    `;
    adminNewsListEl.appendChild(div);
  }

  adminNewsListEl.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-del");
      if (!id) return;
      try{
        btn.disabled = true;
        await deleteNews(id);
        await refreshNewsEverywhere();
      } catch(e){
        adminStatusEl.textContent = e.message;
        adminStatusEl.className = "status danger";
      } finally{
        btn.disabled = false;
      }
    });
  });
}

async function refreshNewsEverywhere(){
  const items = await fetchNewsPublic();
  renderNewsHome(items);
  if (LOGGED_IN_USER === ADMIN_USERNAME) renderNewsAdmin(items);
}

/* =========================
   NAV + VIEWS
   ========================= */
const grid = document.getElementById("grid");

const contentTitle = document.getElementById("contentTitle");
const contentTag   = document.getElementById("contentTag");

const homeView = document.getElementById("homeView");
const aboutView = document.getElementById("aboutView");
const contactView = document.getElementById("contactView");
const adminView = document.getElementById("adminView");
const toolView = document.getElementById("toolView");

function setView(which){
  homeView.hidden = true;
  aboutView.hidden = true;
  contactView.hidden = true;
  adminView.hidden = true;
  toolView.hidden = true;
  grid.classList.remove("toolmode");

  if (which === "home"){
    contentTitle.textContent = "Home";
    contentTag.textContent = "Portal Overview";
    homeView.hidden = false;
    refreshNewsEverywhere().catch(()=>{});
    return;
  }
  if (which === "about"){
    contentTitle.textContent = "About";
    contentTag.textContent = "Info";
    aboutView.hidden = false;
    return;
  }
  if (which === "contact"){
    contentTitle.textContent = "Contact";
    contentTag.textContent = "Info";
    contactView.hidden = false;
    return;
  }
  if (which === "admin"){
    contentTitle.textContent = "Admin";
    contentTag.textContent = "Front Page";
    adminView.hidden = false;
    refreshNewsEverywhere().catch(()=>{});
    return;
  }
  if (which === "tool"){
    contentTitle.textContent = "CID Terminal";
    contentTag.textContent = "Restricted Tool";
    toolView.hidden = false;
    grid.classList.add("toolmode");
    if (!chart) initChart();
    consoleLoop();
    setTimeout(()=>{ try{ chart.resize(); }catch{} }, 50);
    return;
  }
}

const navHome = document.getElementById("navHome");
const navAbout = document.getElementById("navAbout");
const navContact = document.getElementById("navContact");
const navNewsletter = document.getElementById("navNewsletter");
const navLogin = document.getElementById("navLogin");
const navTool = document.getElementById("navTool");
const navAdmin = document.getElementById("navAdmin");
const navLogout = document.getElementById("navLogout");

function updateNav(){
  const loggedIn = !!TOOL_TOKEN;
  navTool.hidden = !loggedIn;
  navLogout.hidden = !loggedIn;
  navAdmin.hidden = !(loggedIn && LOGGED_IN_USER === ADMIN_USERNAME);
}

navHome.addEventListener("click", ()=> setView("home"));
navAbout.addEventListener("click", ()=> setView("about"));
navContact.addEventListener("click", ()=> setView("contact"));
navTool.addEventListener("click", ()=> setView("tool"));
navAdmin.addEventListener("click", ()=> {
  if (LOGGED_IN_USER !== ADMIN_USERNAME) return;
  setView("admin");
});

navLogout.addEventListener("click", ()=>{
  TOOL_TOKEN = null;
  TOOL_IS_ADMIN = false;
  LOGGED_IN_USER = null;
  NEWS_TOKEN = null;
  consoleRunning = false;
  if (screen) screen.textContent = "";
  updateNav();
  setView("home");
});

navLogin.addEventListener("click", ()=>{
  setView("home");
  document.getElementById("loginUser").focus();
  document.getElementById("homeCard").scrollIntoView({ behavior: "smooth", block: "start" });
});

/* =========================
   NEWSLETTER MODAL
   ========================= */
const newsletterBack = document.getElementById("newsletterBack");
const closeNewsletter = document.getElementById("closeNewsletter");
const nlEmail = document.getElementById("nlEmail");
const nlSubmit = document.getElementById("nlSubmit");
const nlStatus = document.getElementById("nlStatus");

navNewsletter.addEventListener("click", ()=>{
  newsletterBack.classList.add("show");
  nlStatus.textContent = "";
  nlStatus.className = "status";
  nlEmail.value = "";
  nlEmail.focus();
});
closeNewsletter.addEventListener("click", ()=> newsletterBack.classList.remove("show"));
newsletterBack.addEventListener("click", (e)=>{
  if (e.target === newsletterBack) newsletterBack.classList.remove("show");
});
nlSubmit.addEventListener("click", ()=>{
  const email = (nlEmail.value||"").trim();
  if (!email || !email.includes("@")){
    nlStatus.textContent = "Invalid email.";
    nlStatus.className = "status danger";
    return;
  }
  nlStatus.textContent = "Subscribed.";
  nlStatus.className = "status ok";
});

/* =========================
   LOGIN FORM
   ========================= */
const loginForm   = document.getElementById("loginForm");
const loginUser   = document.getElementById("loginUser");
const loginPass   = document.getElementById("loginPass");
const loginStatus = document.getElementById("loginStatus");
const loginBtn    = document.getElementById("loginBtn");

loginForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  loginStatus.textContent = "";
  loginStatus.className = "status";
  loginBtn.disabled = true;

  try{
    const u = (loginUser.value || "").trim();
    const p = (loginPass.value || "");
    await toolLogin(u, p);

    if (u === ADMIN_USERNAME){
      await newsLogin(u, p);
    } else {
      NEWS_TOKEN = null;
    }

    loginStatus.textContent = "Access granted.";
    loginStatus.className = "status ok";
    updateNav();
    setView("tool");
  } catch(err){
    loginStatus.textContent = err?.message || "Login failed";
    loginStatus.className = "status danger";
  } finally{
    loginBtn.disabled = false;
    loginPass.value = "";
  }
});

/* =========================
   ADMIN ADD NEWS
   ========================= */
document.getElementById("btnAddNews").addEventListener("click", async ()=>{
  if (LOGGED_IN_USER !== ADMIN_USERNAME){
    adminStatusEl.textContent = "Not authorized.";
    adminStatusEl.className = "status danger";
    return;
  }
  const titleEl = document.getElementById("newsTitle");
  const bodyEl  = document.getElementById("newsBody");
  const title = (titleEl.value || "").trim();
  const text  = (bodyEl.value || "").trim();

  if (!title || !text){
    adminStatusEl.textContent = "Title and body required.";
    adminStatusEl.className = "status danger";
    return;
  }

  try{
    adminStatusEl.textContent = "";
    adminStatusEl.className = "status";
    await createNews(title, text);
    titleEl.value = "";
    bodyEl.value = "";
    adminStatusEl.textContent = "News added.";
    adminStatusEl.className = "status ok";
    await refreshNewsEverywhere();
  } catch(e){
    adminStatusEl.textContent = e.message;
    adminStatusEl.className = "status danger";
  }
});

/* =========================
   TERMINAL TOOL (your logic)
   ========================= */
const TRELLO_SOURCES = [
  { key: "USAR WIDE", json: "https://trello.com/b/zVRnrvhb/usar-management-mainframe.json", list_name: "USAR Blacklists" },
  { key: "FORSCOM",   json: "https://trello.com/b/YncjLEbF/forces-command-information-trello.json", list_name: "Blacklists" },
  { key: "ASOC",      json: "https://trello.com/b/TwIxsGvt/army-special-operations-information.json", list_name: "ASOC Blacklists" },
  { key: "MPC",       json: "https://trello.com/b/IeGd7MBr/military-police-corps-information-board.json", list_name: "Unit Blacklists" },
  { key: "TRADOC",    json: "https://trello.com/b/fUwjef3b/training-and-doctrine-command-information.json", list_name: "PERMANENT TRADOC BLACKLISTS" },
];
const DISPLAY_ORDER = ["USAR WIDE", "FORSCOM", "ASOC", "MPC", "TRADOC"];

const INVENTORY_CATEGORIES = {
  "T-Shirts": 2,
  "Classic Shirts": 11,
  "Classic Pants": 12,
  "Hats": 8,
  "Face": 18,
  "Gear": 19,
  "Hair Accessories": 41,
  "Face Accessories": 42,
  "Neck Accessories": 43,
  "Shoulder Accessories": 44,
  "Front Accessories": 45,
  "Back Accessories": 46,
  "Waist Accessories": 47,
};

const BASE_DELAY_MS = 250;
const JITTER_MS = 200;
const BATCH_DELAY_MS = 900;
const PHASE_DELAY_MS = 900;
const MAX_RETRIES_429 = 7;

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
async function nap(base=BASE_DELAY_MS){ await sleep(base + Math.random()*JITTER_MS); }

const screen = document.getElementById("screen");
function termPrint(text="", cls=null){
  const div = document.createElement("div");
  if (cls) div.className = cls;
  div.textContent = text;
  screen.appendChild(div);
  screen.scrollTop = screen.scrollHeight;
}
function promptLine(label, isPassword=false){
  const row = document.createElement("div");
  row.className = "promptline";

  const p = document.createElement("span");
  p.className = "prompt";
  p.textContent = label;
  row.appendChild(p);

  const input = document.createElement("input");
  input.className = "term";
  input.autocomplete = "off";
  input.spellcheck = false;
  input.type = isPassword ? "password" : "text";
  row.appendChild(input);

  screen.appendChild(row);
  input.focus();
  screen.scrollTop = screen.scrollHeight;

  return new Promise((resolve)=>{
    input.addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){
        const val = input.value;
        row.removeChild(input);
        const shown = document.createElement("span");
        shown.textContent = isPassword ? "•".repeat(Math.min(16, val.length)) : val;
        row.appendChild(shown);
        resolve(val);
      }
    });
  });
}

async function fetchRL(url, opts={}){
  await nap();
  let res = await fetch(url, opts);
  if (res.status !== 429) return res;

  let backoff = 2000;
  for (let i=0; i<MAX_RETRIES_429; i++){
    termPrint(`Rate limited. Sleeping ${(backoff/1000).toFixed(1)}s...`, "muted");
    await sleep(backoff);
    backoff = Math.floor(backoff * 1.55);
    await nap(50);
    res = await fetch(url, opts);
    if (res.status !== 429) return res;
  }
  return res;
}

async function toolApiRL(path, opts={}){
  const res = await fetchRL(`${TOOL_API_BASE}${path}`, opts);
  const data = await res.json().catch(()=> ({}));
  if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
  if (data && data.ok === false) throw new Error(data.error || "Request failed");
  return data;
}

async function trelloFetchBoardJson(trelloUrl){
  const res = await fetchRL(`${TOOL_API_BASE}/trello?url=${encodeURIComponent(trelloUrl)}`, { headers: toolAuthHeaders() });
  const data = await res.json().catch(()=> ({}));
  if (!res.ok) throw new Error(data.error || `Trello HTTP ${res.status}`);
  return data;
}

async function robloxUserId(username){
  const data = await toolApiRL(`/roblox/userid`, {
    method:"POST",
    headers: toolAuthHeaders({ "Content-Type":"application/json" }),
    body: JSON.stringify({ username })
  });
  if (data?.data?.length) return String(data.data[0].id);
  throw new Error("User not found");
}

async function robloxBadges(userId){
  const out = [];
  let cursor = "";
  while(true){
    const url = cursor ? `/roblox/badges?userId=${encodeURIComponent(userId)}&cursor=${encodeURIComponent(cursor)}`
                       : `/roblox/badges?userId=${encodeURIComponent(userId)}`;
    const data = await toolApiRL(url, { headers: toolAuthHeaders() });
    out.push(...(data.data || []));
    cursor = data.nextPageCursor || "";
    if (!cursor) break;
    await sleep(BATCH_DELAY_MS);
  }
  return out;
}

async function robloxAwardedDates(userId, badgeIds){
  const STEP = 100;
  const dates = [];
  for (let i=0; i<badgeIds.length; i+=STEP){
    const batch = badgeIds.slice(i, i+STEP);
    const data = await toolApiRL(`/roblox/awardedDates`, {
      method:"POST",
      headers: toolAuthHeaders({ "Content-Type":"application/json" }),
      body: JSON.stringify({ userId, badgeIds: batch })
    });
    (data.data || []).forEach(x => dates.push(x.awardedDate));
    await sleep(BATCH_DELAY_MS);
  }
  return dates;
}

async function canViewInventory(userId){
  const data = await toolApiRL(`/roblox/canViewInventory?userId=${encodeURIComponent(userId)}`, { headers: toolAuthHeaders() });
  return !!data.canView;
}

async function inventoryItems(userId, assetTypeId){
  const out = [];
  let cursor = "";
  while(true){
    const path =
      `/roblox/inventory?userId=${encodeURIComponent(userId)}&assetTypeId=${encodeURIComponent(assetTypeId)}` +
      (cursor ? `&cursor=${encodeURIComponent(cursor)}` : "");
    const data = await toolApiRL(path, { headers: toolAuthHeaders() });
    out.push(...(data.data || []));
    cursor = data.nextPageCursor || "";
    if (!cursor) break;
    await sleep(BATCH_DELAY_MS);
  }
  return out;
}

function normalize(s){ return (s ?? "").toString().trim().toLowerCase(); }
function usernameInCardName(username, cardName){
  const u = (username ?? "").trim();
  if (!u) return false;
  const cn = (cardName ?? "").trim();
  if (normalize(cn) === "[username]") return false;

  const escaped = u.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  try {
    const re = new RegExp(`(?<![A-Za-z0-9_])${escaped}(?![A-Za-z0-9_])`, "i");
    return re.test(cn);
  } catch {
    const low = cn.toLowerCase();
    const uu = u.toLowerCase();
    const idx = low.indexOf(uu);
    if (idx === -1) return false;
    const before = low[idx-1] || "";
    const after = low[idx+uu.length] || "";
    const word = /[a-z0-9_]/i;
    return !word.test(before) && !word.test(after);
  }
}

async function trelloBlacklistStatus(username){
  const results = {};
  TRELLO_SOURCES.forEach(s => results[s.key] = false);

  for (const src of TRELLO_SOURCES){
    try{
      const board = await trelloFetchBoardJson(src.json);
      const lists = board.lists || [];
      const cards = board.cards || [];
      const listIds = lists.filter(l => normalize(l.name) === normalize(src.list_name)).map(l => l.id);
      if (!listIds.length) { results[src.key] = false; continue; }

      let found = false;
      for (const c of cards){
        if (listIds.includes(c.idList) && usernameInCardName(username, c.name || "")) { found = true; break; }
      }
      results[src.key] = found;
    } catch(e){
      termPrint(`Trello check failed for ${src.key}: ${e.message}`, "muted");
      results[src.key] = false;
    }
    await nap(250);
  }
  return results;
}

const chartStatus = document.getElementById("chartStatus");
const blStatus = document.getElementById("blStatus");
const invStatus = document.getElementById("invStatus");
const blacklistsBox = document.getElementById("blacklistsBox");
const inventoryBox = document.getElementById("inventoryBox");

let chart;
function initChart(){
  const ctx = document.getElementById("chart").getContext("2d");
  chart = new Chart(ctx, {
    type: "scatter",
    data: { datasets: [{ label: "Badges over Time", data: [], pointRadius: 2 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      parsing: false,
      scales: {
        x: { type: "time", time: { unit: "year" }, ticks: { color: "#8fb3a3" }, grid: { color: "rgba(215,251,230,0.08)" } },
        y: { ticks: { color: "#8fb3a3" }, grid: { color: "rgba(215,251,230,0.08)" } }
      },
      plugins: { legend: { labels: { color: "#8fb3a3" } } }
    }
  });
}

function renderBlacklists(statusMap){
  const lines = DISPLAY_ORDER.map(k => `${k} BLACKLIST - ${statusMap[k] ? "YES" : "NO"}`);
  blacklistsBox.textContent = lines.join("\n");
  blStatus.textContent = DISPLAY_ORDER.some(k => statusMap[k]) ? "flags" : "clear";
}

function renderInventory(report){
  const frag = document.createDocumentFragment();
  const kv = document.createElement("div");
  kv.className = "kv";
  const total = Object.values(report).reduce((a, arr)=>a + (arr?.length||0), 0);
  kv.innerHTML = `<span class="chip">categories: ${Object.keys(report).length}</span>
                  <span class="chip">items: ${total}</span>`;
  frag.appendChild(kv);

  Object.entries(report).forEach(([cat, items])=>{
    const h = document.createElement("div");
    h.style.marginTop = "10px";
    h.innerHTML = `<span class="chip">${cat}</span> <span class="muted">(${items.length})</span>`;
    frag.appendChild(h);

    const ul = document.createElement("ul");
    ul.className = "list";
    items.slice(0, 60).forEach(it=>{
      const li = document.createElement("li");
      li.textContent = `${it.name ?? "Unknown"} (AssetId: ${it.assetId ?? "?"})`;
      ul.appendChild(li);
    });
    if (items.length > 60){
      const li = document.createElement("li");
      li.className = "muted";
      li.textContent = `…and ${items.length - 60} more`;
      ul.appendChild(li);
    }
    frag.appendChild(ul);
  });

  inventoryBox.innerHTML = "";
  inventoryBox.appendChild(frag);
}

async function runCheck(username){
  termPrint("");
  termPrint(`Checking user: ${username}`);

  chartStatus.textContent = "running";
  blStatus.textContent = "…";
  invStatus.textContent = "…";
  blacklistsBox.textContent = "Running…";
  inventoryBox.textContent = "Running…";

  termPrint("Fetching Trello blacklists…");
  const bl = await trelloBlacklistStatus(username);
  DISPLAY_ORDER.forEach(k => termPrint(`${k} BLACKLIST - ${bl[k] ? "YES" : "NO"}`));
  renderBlacklists(bl);

  await sleep(PHASE_DELAY_MS);

  termPrint("");
  termPrint("Resolving Roblox user ID…");
  const userId = await robloxUserId(username);
  termPrint(`UserId: ${userId}`);

  await sleep(PHASE_DELAY_MS);

  termPrint("");
  termPrint("Checking inventory visibility…");
  const canView = await canViewInventory(userId);
  if (!canView){
    termPrint("Inventory: PRIVATE (cannot scan items).");
    invStatus.textContent = "private";
    inventoryBox.textContent = "Inventory is private.";
  } else {
    termPrint("Inventory: PUBLIC. Scanning categories (no prices)…");
    const report = {};
    for (const [cat, typeId] of Object.entries(INVENTORY_CATEGORIES)){
      termPrint(`- Fetching ${cat}…`, "muted");
      try{
        const items = await inventoryItems(userId, typeId);
        report[cat] = items.map(x => ({ name: x.name, assetId: x.assetId }));
      } catch(e){
        termPrint(`  Inventory category failed (${cat}): ${e.message}`, "muted");
        report[cat] = [];
      }
      await sleep(250);
    }
    invStatus.textContent = "done";
    renderInventory(report);
  }

  await sleep(PHASE_DELAY_MS);

  termPrint("");
  termPrint("Fetching badges…");
  const badges = await robloxBadges(userId);
  termPrint(`Badges found: ${badges.length}`);

  termPrint("Fetching awarded dates…");
  const badgeIds = badges.map(b=>b.id).filter(Boolean);
  const dates = await robloxAwardedDates(userId, badgeIds);

  const parsed = dates.map(s => new Date(s)).filter(d => !isNaN(d.getTime())).sort((a,b)=>a-b);
  const points = parsed.map((d, idx)=>({ x: d, y: idx+1 }));
  chart.data.datasets[0].data = points;
  chart.update();

  chartStatus.textContent = "done";
  termPrint("Badge chart updated.");
  termPrint("");
}

function printHelp(){
  termPrint("Commands:");
  termPrint("  check <roblox_username>       Run background check");
  termPrint("  logout");
  termPrint("  help");
}

let consoleRunning = false;
async function consoleLoop(){
  if (consoleRunning) return;
  consoleRunning = true;

  termPrint("CID Secure Console v1.0");
  termPrint("Authorized personnel only.");
  termPrint("");
  printHelp();
  termPrint("");

  while(true){
    const cmd = await promptLine("cid> ");
    await toolLogCommand(cmd);

    const parts = cmd.trim().split(/\s+/).filter(Boolean);
    if (!parts.length) continue;

    const base = parts[0].toLowerCase();

    try{
      if (base === "help"){ printHelp(); continue; }
      if (base === "logout"){
        navLogout.click();
        return;
      }
      if (base === "check"){
        const user = parts.slice(1).join(" ");
        if (!user){ termPrint("Usage: check <roblox_username>"); continue; }
        await runCheck(user); continue;
      }
      termPrint(`Unknown command: ${base}`, "danger");
    } catch(e){
      termPrint(`ERROR: ${e.message}`, "danger");
      chartStatus.textContent = "error";
    }
  }
}

updateNav();
setView("home");
refreshNewsEverywhere().catch(()=>{});
</script>
</body>
</html>
